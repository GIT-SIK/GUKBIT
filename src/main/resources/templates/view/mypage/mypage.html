<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>GUKBIT</title>
  <div th:replace="fragments/head.html :: fragment-head"></div>
  <link rel="stylesheet" th:href="@{/css/mypage.css}" type="text/css"/>
  <script th:src="@{/js/header.js}"></script>
  <script th:src="@{/js/mypageValidation.js}"></script>
  <style>
    .field-error {
      border-color: #dc3545 !important;
      color: #dc3545 !important;
    }
  </style>
</head>
<body>
<div th:replace="fragments/header.html :: fragment-header"></div>
<div class="container-fluid p-0 m-0">
  <div th:replace="fragments/nav.html :: fragment-nav"></div>
</div>

<section class="container text-center">
  <div class="ui_box">
    <div class="userInfo_myPage">마이페이지</div>
    <form method="post" action="/user/mypage/ocr" enctype="multipart/form-data">
      <input type="file" name="ocrFile">
      <button type="submit">submit</button>
    </form>
    <form class="userInfo" method="post" th:action="@{/user/mypage/update}"
          th:object="${updateUserData}">
      <input th:field="*{user}" type="hidden">
      <div class="userInfo_row">
        <span class="userInfo_title">아이디</span>
        <input class="userInfo_field" id="id" placeholder="아이디" readonly
               th:field="*{user.userId}" type="text"/>
      </div>
      <div class="userInfo_row">
        <span class="userInfo_title">이메일</span>
        <input
            class="userInfo_field"
            id="email"
            placeholder="이메일"
            readonly
            th:field="*{user.email}"
            type="email"
        />
      </div>
      <div class="userInfo_row">
        <span class="userInfo_title">휴대폰</span>
        <input class="userInfo_field" id="phone" placeholder="휴대폰" readonly
               th:field="*{user.tel}" type="text"/>
      </div>
      <div class="userInfo_row">
        <span class="userInfo_title">변경하실 비밀번호</span>
        <input class="userInfo_field" id="changePassword" placeholder="비밀번호를 입력해주세요"
               th:errorclass="field-error" th:field="*{changePassword}"
               type="password"/>
      </div>
      <div class="field-error" th:errors="*{changePassword}"></div>
      <!-- 비밀번호 유효성 검사 -->
      <div class="pw_regex"></div>
      <div class="userInfo_row">
        <span class="userInfo_title">비밀번호 확인</span>
        <input class="userInfo_field" id="changePasswordCheck" placeholder="비밀번호를 다시 입력해 주세요"
               th:errorclass="field-error" th:field="*{changePasswordCheck}"
               type="password"/>
      </div>
      <div class="field-error" th:errors="*{changePasswordCheck}"></div>
      <!-- 비밀번호 같은지 확인 -->
      <div class="pwauth_regex"></div>
      <div class="userInfo_row">
        <span class="userInfo_title">과정코드 인증하기</span>
        <input type="button" value="클릭" onclick="imageOcr()"></input>
      </div>

      <div class="userInfo_row">
        <!-- 과정 코드 확인 로직 -->

        <span class="userInfo_title">과정코드</span>
        <input class="userInfo_field" id="courseId" placeholder="과정코드를 입력해주세요" type="text"/>
        <input class="userInfoBtn" id="courseIdSave" onclick="getCourseData()" th:value="검색" type="button"></input>
      </div>
      <div id="courseDropBox" name="courseDropBox">
        <select class="form-select">
          <option disabled selected value="">과정명 선택</option>
        </select>
      </div>
      <div class="userInfo_row">
        <span class="userInfo_title">인증된 과정 목록</span>
        <input class="userInfo_field" id="authCourse" placeholder="과정 코드 / 과정명" readonly th:field="*{authUserData.courseName}" type="text"/>

      </div>
      <div class="userInfo_row">
        <span class="userInfo_title">평점 작성 기록</span>
        <input class="userInfo_field" id="comment" placeholder="한줄평 / 평점" readonly th:field="*{rate.oneStatement}" type="text"/>
        <a type="button" class="reset-a userInfoBtn" id="authCourseRewrite" style="display:grid; align-items:center;"
           th:href="@{/academy/rate/review-input/change(code=${updateUserData.authUserData.getAcademyCode()} )}">수정 / 삭제</a>
        <input id="academy-code" th:value="${updateUserData.authUserData.academyCode}" type="hidden"></input>
      </div>

      <div class="userInfo_signup">
        <input class="userInfoBtn" th:name="update" th:value="수정" type="submit"></input>
        <input class="userInfoBtn" onclick="location.href='/'" th:value="취소" type="button"></input>
        <input class="userInfoBtn" onclick="userDelete()" th:name="delete" th:value="회원탈퇴" type="button"></input>
      </div>
    </form>
  </div>
</section>

<div class="container">
  <div th:replace="fragments/footer.html :: fragment-footer"></div>
</div>

<script th:inline="javascript">
  function imageOcr() {
    Swal.fire({
      title: 'Select a file',
      showCancelButton: true,
      confirmButtonText: 'Upload',
      input: 'file',
      onBeforeOpen: () => {
        $(".swal2-file").change(function () {
          var reader = new FileReader();
          reader.readAsDataURL(this.files[0]);
        });
      }
    }).then((file) => {
      if (file.value) {
        var formData = new FormData();
        var file = $('.swal2-file')[0].files[0];
        formData.append("ocrFile", file);
        $.ajax({
          method: 'post',
          url: '/user/mypage/ocr',
          data: formData,
          processData: false,
          contentType: false,
          success: function (resp) {
            Swal.fire('Uploaded', 'Your file have been uploaded', 'success');
          },
          error: function () {
            Swal.fire({type: 'error', title: 'Oops...', text: 'Something went wrong!'})
          }
        })
      }
    })

    // Swal.fire({
    //   title: 'Select image',
    //   html: '<input id="fileupload" type="file" name="userfile">'
    // }).then(function () {
    //   var formData = new FormData();
    //   formData.append('ocrFile', $('#fileupload')[0].files[0]);
    //   console.log(formData);
    //   $.ajax({
    //     url: "/user/mypage/ocr",
    //     type: 'post',
    //     processData: false,
    //     contentType: false,
    //     data: FormData,
    //     success: function (json) {
    //       alert("등록되었습니다.");
    //     },
    //     error: function (xhr, status, error) {
    //       alert("가입에 실패했습니다." + error);
    //     }
    //   });
    // });
  }
  function getCourseData() {
    let cId = $("#courseId").val();
    let courseId = cId.trim();
    $.ajax({
      url: "/course/courseData",
      type: 'get',
      data: {CourseId: courseId},
      success: function (html) {
        Swal.fire("","드랍박스가 갱신되었습니다.","info")
        $("#courseDropBox").html(html);
      },
    });
  }
  function userDelete(){
    Swal.fire({
      title: '정말 회원 탈퇴를 하시겠습니까?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#0059ab',
      cancelButtonColor: '#D5D5D5',
      confirmButtonText: '확인',
      cancelButtonText: '취소'
    }).then((result) => {
      if (result.isConfirmed) {
        location.assign('mypage/delete');
        return false;
      }
    })
  };
</script>
<script th:src="@{/js/navigo.js}"></script>
</body>
</html>
